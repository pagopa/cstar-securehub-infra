{
    "name": "idpay_transaction_copy",
    "properties": {
        "activities": [
            {
                "name": "Copy transaction collection",
                "type": "Copy",
                "dependsOn": [
                    {
                        "activity": "Clear transaction table",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "source": {
                        "type": "CosmosDbMongoDbApiSource",
                        "batchSize": 100
                    },
                    "sink": {
                        "type": "AzureDataExplorerSink"
                    },
                    "enableStaging": false,
                    "translator": {
                        "type": "TabularTranslator",
                        "mappings": [
                            { "source": { "path": "$['_id']" }, "sink": { "name": "_id", "type": "String" } },
                            { "source": { "path": "$['userId']" }, "sink": { "name": "userId", "type": "String" } },
                            { "source": { "path": "$['familyId']" }, "sink": { "name": "familyId", "type": "String" } },
                            { "source": { "path": "$['initiativeId']" }, "sink": { "name": "initiativeId", "type": "String" } },
                            { "source": { "path": "$['status']" }, "sink": { "name": "status", "type": "String" } },
                            { "source": { "path": "$['userMail']" }, "sink": { "name": "userMail", "type": "String" } },
                            { "source": { "path": "$['channel']" }, "sink": { "name": "channel", "type": "String" } },
                            { "source": { "path": "$['tc']" }, "sink": { "name": "tc", "type": "Boolean" } },
                            { "source": { "path": "$['pdndAccept']" }, "sink": { "name": "pdndAccept", "type": "Boolean" } },

                            { "source": { "path": "tcAcceptTimestamp.$date.$numberLong" },
                                "sink": { "name": "tcAcceptTimestampString", "type": "String" } },

                            { "source": { "path": "criteriaConsensusTimestamp.$date.$numberLong" },
                                "sink": { "name": "criteriaConsensusTimestampString", "type": "String" } },

                            { "source": { "path": "onboardingOkDate.$date.$numberLong" },
                                "sink": { "name": "onboardingOkDateString", "type": "String" } },

                            { "source": { "path": "updateDate.$date.$numberLong" },
                                "sink": { "name": "updateDateString", "type": "String" } },

                            { "source": { "path": "$['detailKO']" }, "sink": { "name": "detailKO", "type": "String" } },

                        ],

                        "collectionReference": "",
                        "mapComplexValuesToString": true
                    }
                },
                "inputs": [
                    {
                        "referenceName": "cosmos_idpay_transaction",
                        "type": "DatasetReference"
                    }
                ],
                "outputs": [
                    {
                        "referenceName": "data_explorer_idpay_transaction",
                        "type": "DatasetReference"
                    }
                ]
            },
            {
                "name": "Clear transaction table",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".clear table transaction data",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            },
            {
                "name": "Extract RejectionReasons",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [
                    {
                        "activity": "Convert Date",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".set-or-replace transaction_rejection_reasons <|\ntransaction\n| extend rejectionArray = parse_json(rejectionReasons)\n| mv-expand rejectionArray\n| project transactionId = _id, rejectionReason = tostring(rejectionArray)",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            },
            {
                "name": "Extract InitiativeRejectionReasons",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [
                    {
                        "activity": "Extract RejectionReasons",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".set-or-replace transaction_initiative_rejection_reasons <|\ntransaction\n| extend initiativeRejectionMap = parse_json(initiativeRejectionReasons)\n| mv-expand initiativeId = bag_keys(initiativeRejectionMap)\n| extend initiativeId = tostring(initiativeId)\n| extend rejectionList = initiativeRejectionMap[initiativeId]\n| mv-expand rejectionReason = rejectionList\n| project transactionId = _id, initiativeId, rejectionReason = tostring(rejectionReason)",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            },
            {
                "name": "Convert Date",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [
                    {
                        "activity": "Copy transaction collection",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".set-or-replace transaction <|\ntransaction\n| extend \n    trxDate = unixtime_milliseconds_todatetime(tolong(trxDateString)),\n    trxChargeDate = unixtime_milliseconds_todatetime(tolong(trxChargeDateString)),\n    elaborationDateTime = unixtime_milliseconds_todatetime(tolong(elaborationDateTimeString))",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            }
        ],
        "annotations": [],
        "lastPublishTime": "2025-10-10T11:15:48Z"
    },
    "type": "Microsoft.DataFactory/factories/pipelines"
}
