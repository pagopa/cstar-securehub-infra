{
    "name": "idpay_onboarding_citizen_copy",
    "properties": {
        "activities": [
            {
                "name": "Copy onboarding citizen collection",
                "type": "Copy",
                "dependsOn": [
                    {
                        "activity": "Clear onboarding_citizen table",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "source": {
                        "type": "CosmosDbMongoDbApiSource",
                        "batchSize": 100
                    },
                    "sink": {
                        "type": "AzureDataExplorerSink"
                    },
                    "enableStaging": false,
                    "translator": {
                        "type": "TabularTranslator",
                        "mappings": [
                            { "source": { "path": "$['_id']" }, "sink": { "name": "_id", "type": "String" } },
                            { "source": { "path": "$['userId']" }, "sink": { "name": "userId", "type": "String" } },
                            { "source": { "path": "$['familyId']" }, "sink": { "name": "familyId", "type": "String" } },
                            { "source": { "path": "$['initiativeId']" }, "sink": { "name": "initiativeId", "type": "String" } },
                            { "source": { "path": "$['status']" }, "sink": { "name": "status", "type": "String" } },
                            { "source": { "path": "$['userMail']" }, "sink": { "name": "userMail", "type": "String" } },
                            { "source": { "path": "$['channel']" }, "sink": { "name": "channel", "type": "String" } },
                            { "source": { "path": "$['tc']" }, "sink": { "name": "tc", "type": "Boolean" } },
                            { "source": { "path": "$['pdndAccept']" }, "sink": { "name": "pdndAccept", "type": "Boolean" } },

                            { "source": { "path": "tcAcceptTimestamp.$date" },
                                "sink": { "name": "tcAcceptTimestampString", "type": "String" } },

                            { "source": { "path": "criteriaConsensusTimestamp.$date" },
                                "sink": { "name": "criteriaConsensusTimestampString", "type": "String" } },

                            { "source": { "path": "onboardingOkDate.$date" },
                                "sink": { "name": "onboardingOkDateString", "type": "String" } },

                            { "source": { "path": "updateDate.$date" },
                                "sink": { "name": "updateDateString", "type": "String" } },

                            { "source": { "path": "$['detailKO']" }, "sink": { "name": "detailKO", "type": "String" } }

                        ],

                        "collectionReference": "",
                        "mapComplexValuesToString": true
                    }
                },
                "inputs": [
                    {
                        "referenceName": "cosmos_idpay_onboarding_citizen",
                        "type": "DatasetReference"
                    }
                ],
                "outputs": [
                    {
                        "referenceName": "data_explorer_idpay_onboarding_citizen",
                        "type": "DatasetReference"
                    }
                ]
            },
            {
                "name": "Clear onboarding_citizen table",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".clear table onboarding_citizen data",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            },
            {
                "name": "Convert Date",
                "type": "AzureDataExplorerCommand",
                "dependsOn": [
                    {
                        "activity": "Copy onboarding citizen collection",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "userProperties": [],
                "typeProperties": {
                    "command": ".set-or-replace onboarding_citizen <|\nonboarding_citizen\n| extend \n    tcAcceptTimestamp = unixtime_milliseconds_todatetime(tolong(tcAcceptTimestampString)),\n    criteriaConsensusTimestamp = unixtime_milliseconds_todatetime(tolong(criteriaConsensusTimestampString)),\n    onboardingOkDate = unixtime_milliseconds_todatetime(tolong(onboardingOkDateString)),\n    updateDate = unixtime_milliseconds_todatetime(tolong(updateDateString))",
                    "commandTimeout": "00:20:00"
                },
                "linkedServiceName": {
                    "referenceName": "idpay-Kusto-idpay-ls",
                    "type": "LinkedServiceReference"
                }
            }
        ],
        "annotations": [],
        "lastPublishTime": "2025-10-10T11:15:48Z"
    },
    "type": "Microsoft.DataFactory/factories/pipelines"
}
